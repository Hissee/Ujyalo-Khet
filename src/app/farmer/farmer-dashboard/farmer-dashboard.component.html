<div class="farmer-dashboard-container">
  <div class="dashboard-header mb-4">
    <h2><i class="bi bi-speedometer2"></i> Farmer Dashboard</h2>
    <p class="text-muted">Manage your products, orders, and track your business</p>
  </div>

  @if (error) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  }

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'overview'"
        (click)="switchTab('overview')">
        <i class="bi bi-graph-up"></i> Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'orders'"
        (click)="switchTab('orders')">
        <i class="bi bi-cart-check"></i> Orders
        @if (stats?.orders?.total) {
          <span class="badge bg-primary ms-1">{{ stats?.orders?.total }}</span>
        }
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'products'"
        (click)="switchTab('products')">
        <i class="bi bi-box-seam"></i> Products
        @if (stats?.products?.total) {
          <span class="badge bg-success ms-1">{{ stats?.products?.total }}</span>
        }
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'revenue'"
        (click)="switchTab('revenue')">
        <i class="bi bi-cash-coin"></i> Revenue
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'profile'"
        (click)="switchTab('profile')">
        <i class="bi bi-person"></i> Profile
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    @if (activeTab === 'overview') {
      <div class="tab-pane fade show active">
        @if (loadingStats) {
          <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading dashboard...</p>
          </div>
        } @else if (stats) {
          <!-- Statistics Cards -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card text-center border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary"><i class="bi bi-currency-dollar"></i></h5>
                  <h3 class="mb-0">{{ formatCurrency(stats.overview.totalRevenue) }}</h3>
                  <small class="text-muted">Total Revenue</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center border-success">
                <div class="card-body">
                  <h5 class="card-title text-success"><i class="bi bi-cart-check"></i></h5>
                  <h3 class="mb-0">{{ stats.overview.totalOrders }}</h3>
                  <small class="text-muted">Total Orders</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center border-info">
                <div class="card-body">
                  <h5 class="card-title text-info"><i class="bi bi-box-seam"></i></h5>
                  <h3 class="mb-0">{{ stats.overview.totalProducts }}</h3>
                  <small class="text-muted">Total Products</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning"><i class="bi bi-bag-check"></i></h5>
                  <h3 class="mb-0">{{ stats.overview.totalProductsSold }}</h3>
                  <small class="text-muted">Items Sold</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Status Overview -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-list-check"></i> Order Status</h5>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Pending:</span>
                    <span class="badge bg-warning">{{ stats.orders.pending }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Confirmed:</span>
                    <span class="badge bg-info">{{ stats.orders.confirmed }}</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Delivered:</span>
                    <span class="badge bg-success">{{ stats.orders.delivered }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-box-seam"></i> Product Status</h5>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Available:</span>
                    <span class="badge bg-success">{{ stats.products.available }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Sold Out:</span>
                    <span class="badge bg-danger">{{ stats.products.soldOut }}</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Total Stock:</span>
                    <strong>{{ stats.products.totalStock }}</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Orders -->
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Orders</h5>
              <button class="btn btn-sm btn-outline-primary" (click)="switchTab('orders')">
                View All
              </button>
            </div>
            <div class="card-body">
              @if (stats.recentOrders.length === 0) {
                <p class="text-muted text-center py-3">No recent orders</p>
              } @else {
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Date</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (order of stats.recentOrders; track order.orderId) {
                        <tr>
                          <td>{{ order.orderId.substring(0, 8) }}...</td>
                          <td>{{ order.customerName }}</td>
                          <td>{{ formatCurrency(order.totalAmount) }}</td>
                          <td><span class="badge" [class]="getStatusBadgeClass(order.status)">{{ order.status }}</span></td>
                          <td><span class="badge" [class]="getPaymentStatusBadgeClass(order.paymentStatus)">{{ order.paymentStatus }}</span></td>
                          <td>{{ formatDate(order.createdAt) }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Orders Tab -->
    @if (activeTab === 'orders') {
      <div class="tab-pane fade show active">
        @if (loadingOrders) {
          <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading orders...</p>
          </div>
        } @else if (orders.length === 0) {
          <div class="alert alert-info">
            <h5>No orders yet</h5>
            <p>Orders will appear here when customers purchase your products.</p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Products</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payment</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (order of orders; track order._id) {
                  <tr>
                    <td>{{ order.orderId.substring(0, 8) }}...</td>
                    <td>
                      <strong>{{ order.customerName }}</strong><br>
                      <small class="text-muted">{{ order.customerEmail }}</small>
                    </td>
                    <td>
                      @for (product of order.products; track product.productId) {
                        <div>{{ product.productName }} (x{{ product.quantity }})</div>
                      }
                    </td>
                    <td><strong>{{ formatCurrency(order.totalAmount) }}</strong></td>
                    <td><span class="badge" [class]="getStatusBadgeClass(order.status)">{{ order.status }}</span></td>
                    <td><span class="badge" [class]="getPaymentStatusBadgeClass(order.paymentStatus)">{{ order.paymentStatus }}</span></td>
                    <td>{{ formatDate(order.createdAt) }}</td>
                    <td>
                      <button class="btn btn-sm btn-primary" (click)="openOrderDetails(order)">
                        <i class="bi bi-eye"></i> View
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }

    <!-- Products Tab -->
    @if (activeTab === 'products') {
      <div class="tab-pane fade show active">
        <div class="d-flex justify-content-between mb-3">
          <h5>My Products</h5>
          <button class="btn btn-primary" (click)="navigateToAddProduct()">
            <i class="bi bi-plus-circle"></i> Add New Product
          </button>
        </div>

        @if (loadingProducts) {
          <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading products...</p>
          </div>
        } @else if (products.length === 0) {
          <div class="alert alert-info">
            <h5>No products yet</h5>
            <p>Start by adding your first product!</p>
            <button class="btn btn-primary" (click)="navigateToAddProduct()">
              Add Product
            </button>
          </div>
        } @else {
          <div class="row">
            @for (product of products; track product._id) {
              <div class="col-md-4 mb-4">
                <div class="card h-100">
                  @if (product.images && product.images.length > 0) {
                    <img [src]="product.images[0]" class="card-img-top" [alt]="product.name" style="height: 200px; object-fit: cover;">
                  }
                  <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text text-muted">{{ product.description }}</p>
                    <div class="mb-2">
                      <span class="badge bg-primary">{{ product.category }}</span>
                      <span class="badge ms-2" [class.bg-success]="product.status === 'available'" [class.bg-danger]="product.status === 'sold out'">
                        {{ product.status }}
                      </span>
                    </div>
                    <p class="mb-1"><strong>Price:</strong> {{ formatCurrency(product.price) }}</p>
                    <p class="mb-1"><strong>Stock:</strong> {{ product.quantity }}</p>
                  </div>
                  <div class="card-footer">
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-primary flex-fill" (click)="navigateToUpdateProduct(product._id)">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button 
                        class="btn btn-sm btn-outline-danger" 
                        (click)="deleteProduct(product._id, product.name)"
                        title="Delete product">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Revenue Tab -->
    @if (activeTab === 'revenue') {
      <div class="tab-pane fade show active">
        <div class="mb-3">
          <label class="form-label">Select Period:</label>
          <select class="form-select" [(ngModel)]="revenueDays" (change)="loadRevenue()" style="width: 200px; display: inline-block;">
            <option [value]="7">Last 7 days</option>
            <option [value]="30">Last 30 days</option>
            <option [value]="90">Last 90 days</option>
            <option [value]="365">Last year</option>
          </select>
        </div>

        @if (loadingRevenue) {
          <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading revenue data...</p>
          </div>
        } @else if (revenueData) {
          <div class="card mb-4">
            <div class="card-body text-center">
              <h3 class="text-primary">{{ formatCurrency(revenueData.totalRevenue) }}</h3>
              <p class="text-muted">Total Revenue (Last {{ revenueDays }} days)</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Daily Revenue Breakdown</h5>
            </div>
            <div class="card-body">
              @if (!hasRevenueData()) {
                <p class="text-muted text-center py-3">No revenue data for this period</p>
              } @else {
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Revenue</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (date of getRevenueDates(); track date) {
                        <tr>
                          <td>{{ formatDate(date) }}</td>
                          <td><strong>{{ formatCurrency(revenueData.revenueByDate[date] || 0) }}</strong></td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Profile Tab -->
    @if (activeTab === 'profile') {
      <div class="tab-pane fade show active">
        @if (loadingProfile) {
          <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading profile...</p>
          </div>
        } @else if (user) {
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-person-circle"></i> Profile Information</h5>
              <button class="btn btn-sm btn-outline-primary" (click)="profileEditMode = !profileEditMode">
                {{ profileEditMode ? 'Cancel' : 'Edit' }}
              </button>
            </div>
            <div class="card-body">
              @if (profileEditMode) {
                <form>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">First Name</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.firstName" name="firstName">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Middle Name</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.middleName" name="middleName">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Last Name</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.lastName" name="lastName">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" [value]="user.email" disabled>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-control" [(ngModel)]="profileData.phone" name="phone">
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Province</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.province" name="province">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">City</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.city" name="city">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Street</label>
                      <input type="text" class="form-control" [(ngModel)]="profileData.street" name="street">
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary" (click)="saveProfile()" [disabled]="loadingProfile">
                    @if (loadingProfile) {
                      <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Save Changes
                  </button>
                </form>
              } @else {
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <strong>Name:</strong> {{ user.name }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <strong>Email:</strong> {{ user.email }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <strong>Phone:</strong> {{ user.phone || 'N/A' }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <strong>Role:</strong> <span class="badge bg-primary">{{ user.role }}</span>
                  </div>
                  @if (user.address) {
                    <div class="col-12 mb-3">
                      <strong>Address:</strong><br>
                      {{ user.address.street }}, {{ user.address.city }}, {{ user.address.province }}
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Order Details Modal -->
  @if (selectedOrder) {
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Order Details</h5>
            <button type="button" class="btn-close" (click)="closeOrderDetails()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Order ID:</strong> {{ selectedOrder.orderId }}<br>
              <strong>Customer:</strong> {{ selectedOrder.customerName }}<br>
              <strong>Email:</strong> {{ selectedOrder.customerEmail }}<br>
              <strong>Phone:</strong> {{ selectedOrder.customerPhone }}
            </div>

            <div class="mb-3">
              <strong>Products:</strong>
              <ul class="list-group mt-2">
                @for (product of selectedOrder.products; track product.productId) {
                  <li class="list-group-item">
                    {{ product.productName }} - 
                    Quantity: {{ product.quantity }} Ã— {{ formatCurrency(product.price) }} = 
                    <strong>{{ formatCurrency(product.total) }}</strong>
                  </li>
                }
              </ul>
            </div>

            <div class="mb-3">
              <strong>Delivery Address:</strong><br>
              {{ selectedOrder.deliveryAddress?.street }}, 
              {{ selectedOrder.deliveryAddress?.city }}, 
              {{ selectedOrder.deliveryAddress?.province }}
            </div>

            <div class="mb-3">
              <strong>Total Amount:</strong> {{ formatCurrency(selectedOrder.totalAmount) }}<br>
              <strong>Status:</strong> <span class="badge" [class]="getStatusBadgeClass(selectedOrder.status)">{{ selectedOrder.status }}</span><br>
              <strong>Payment Method:</strong> {{ selectedOrder.paymentMethod }}<br>
              <strong>Payment Status:</strong> <span class="badge" [class]="getPaymentStatusBadgeClass(selectedOrder.paymentStatus)">{{ selectedOrder.paymentStatus }}</span>
            </div>

            <div class="mb-3">
              <label class="form-label">Update Status:</label>
              <select class="form-select" [(ngModel)]="newStatus">
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeOrderDetails()">Close</button>
            <button type="button" class="btn btn-primary" (click)="updateOrderStatus(selectedOrder.orderId)">
              Update Status
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
