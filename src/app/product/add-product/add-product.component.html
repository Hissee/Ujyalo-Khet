<div class="container mt-4 mb-5">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Product</h3>
        <button type="button" class="btn btn-light btn-sm" (click)="cancel()">
          <i class="bi bi-x-lg"></i> Close
        </button>
      </div>
    </div>
    <div class="card-body p-4">
      @if (successMessage) {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle"></i> {{ successMessage }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      }

      @if (errorMessage) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      }

      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <!-- Product Name -->
        <div class="mb-3">
          <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
          <input 
            type="text" 
            class="form-control" 
            id="name"
            formControlName="name"
            placeholder="e.g., Fresh Tomatoes"
            [class.is-invalid]="isFieldInvalid('name')">
          @if (isFieldInvalid('name')) {
            <div class="invalid-feedback">
              {{ getFieldError('name') }}
            </div>
          }
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea 
            class="form-control" 
            id="description"
            formControlName="description"
            rows="4"
            placeholder="Describe your product..."></textarea>
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
          <select 
            class="form-select" 
            id="category"
            formControlName="category"
            [class.is-invalid]="isFieldInvalid('category')">
            <option value="">Select a category</option>
            @for (category of categories; track category) {
              <option [value]="category">{{ category }}</option>
            }
          </select>
          @if (isFieldInvalid('category')) {
            <div class="invalid-feedback">
              {{ getFieldError('category') }}
            </div>
          }
        </div>

        <!-- Price and Quantity -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="price" class="form-label">Price (Rs) <span class="text-danger">*</span></label>
            <input 
              type="number" 
              class="form-control" 
              id="price"
              formControlName="price"
              placeholder="0.00"
              step="0.01"
              min="0.01"
              [class.is-invalid]="isFieldInvalid('price')">
            @if (isFieldInvalid('price')) {
              <div class="invalid-feedback">
                {{ getFieldError('price') }}
              </div>
            }
          </div>
          <div class="col-md-6">
            <label for="quantity" class="form-label">Quantity (Stock) <span class="text-danger">*</span></label>
            <input 
              type="number" 
              class="form-control" 
              id="quantity"
              formControlName="quantity"
              placeholder="0"
              min="1"
              [class.is-invalid]="isFieldInvalid('quantity')">
            @if (isFieldInvalid('quantity')) {
              <div class="invalid-feedback">
                {{ getFieldError('quantity') }}
              </div>
            }
          </div>
        </div>

        <!-- Harvest Date and Organic -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="harvestDate" class="form-label">Harvest Date</label>
            <input 
              type="date" 
              class="form-control" 
              id="harvestDate"
              formControlName="harvestDate">
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check form-switch">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="organic"
                formControlName="organic">
              <label class="form-check-label" for="organic">
                <i class="bi bi-leaf"></i> Organic Product
              </label>
            </div>
          </div>
        </div>

        <!-- Product Images -->
        <div class="mb-3">
          <label class="form-label">Product Images</label>
          
          <!-- File Upload -->
          <div class="mb-3">
            <label for="imageUpload" class="btn btn-outline-primary w-100">
              <i class="bi bi-cloud-upload"></i> Choose Images to Upload
              <input 
                type="file" 
                id="imageUpload" 
                class="d-none" 
                accept="image/*" 
                multiple
                (change)="onFileSelected($event)">
            </label>
            <small class="form-text text-muted d-block mt-1">
              You can select multiple images at once (JPG, PNG, GIF, etc.)
            </small>
          </div>

          <!-- Or Add URL -->
          <div class="mb-2">
            <label class="form-label small">Or enter image URL:</label>
            <div class="input-group">
              <input 
                type="url" 
                class="form-control" 
                [(ngModel)]="newImageUrl"
                placeholder="https://example.com/image.jpg"
                name="imageUrl">
              <button 
                type="button" 
                class="btn btn-outline-secondary" 
                (click)="addImageUrl()"
                [disabled]="uploadingImages">
                <i class="bi bi-plus"></i> Add URL
              </button>
            </div>
          </div>

          <!-- Image Previews -->
          @if (uploadingImages) {
            <div class="alert alert-info">
              <i class="bi bi-hourglass-split"></i> Uploading images...
            </div>
          }

          @if (imageUrls.length > 0) {
            <div class="mt-3">
              <small class="text-muted d-block mb-2">
                <strong>Added Images ({{ imageUrls.length }}):</strong>
              </small>
              <div class="d-flex flex-wrap gap-2">
                @for (imageUrl of imageUrls; track $index) {
                  <div class="position-relative d-inline-block">
                    <img 
                      [src]="imageUrl" 
                      alt="Product image" 
                      class="img-thumbnail"
                      style="width: 120px; height: 120px; object-fit: cover; cursor: pointer;"
                      onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZTwvdGV4dD48L3N2Zz4='">
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle"
                      style="transform: translate(50%, -50%); width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center;"
                      (click)="removeImageUrl($index)"
                      title="Remove image">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="alert alert-warning mt-2">
              <i class="bi bi-info-circle"></i> No images added yet. Adding at least one image is recommended.
            </div>
          }
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex justify-content-between mt-4">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cancel()"
            [disabled]="loading">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="loading || productForm.invalid">
            @if (loading) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Adding...
            } @else {
              <i class="bi bi-check-circle"></i> Add Product
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>