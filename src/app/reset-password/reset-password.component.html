<div class="container mt-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-4">Reset Password</h2>
    
    @if (!tokenValid) {
      <div class="alert alert-danger mb-3" role="alert">
        <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
      </div>
      <div class="text-center">
        <a routerLink="/forgot-password" class="btn btn-success">Request New OTP</a>
      </div>
    } @else {
      <p class="text-muted text-center mb-4">Enter your new password below.</p>
      
      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()">
        <!-- Password -->
        <div class="mb-3">
          <label for="password" class="form-label">New Password</label>
          <div class="position-relative">
            <input 
              [type]="showPassword ? 'text' : 'password'" 
              id="password" 
              class="form-control" 
              formControlName="password" 
              placeholder="Enter new password (min 6 characters)" 
              style="padding-right: 3rem;"
              required>
            <button 
              type="button" 
              class="btn btn-link position-absolute top-50 translate-middle-y" 
              (click)="togglePasswordVisibility()"
              [disabled]="loading"
              style="right: 0.75rem; border: none; background: none; z-index: 10; cursor: pointer; padding: 0; transform: translateY(-50%);">
              <i [class]="showPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" style="font-size: 1.2rem;"></i>
            </button>
          </div>
          @if (resetPasswordForm.get('password')?.invalid && resetPasswordForm.get('password')?.touched) {
            <small class="text-danger">
              @if (resetPasswordForm.get('password')?.errors?.['required']) {
                Password is required
              } @else if (resetPasswordForm.get('password')?.errors?.['minlength']) {
                Password must be at least 6 characters
              }
            </small>
          }
        </div>

        <!-- Confirm Password -->
        <div class="mb-4">
          <label for="confirmPassword" class="form-label">Confirm Password</label>
          <div class="position-relative">
            <input 
              [type]="showConfirmPassword ? 'text' : 'password'" 
              id="confirmPassword" 
              class="form-control" 
              formControlName="confirmPassword" 
              placeholder="Confirm new password" 
              style="padding-right: 3rem;"
              required>
            <button 
              type="button" 
              class="btn btn-link position-absolute top-50 translate-middle-y" 
              (click)="toggleConfirmPasswordVisibility()"
              [disabled]="loading"
              style="right: 0.75rem; border: none; background: none; z-index: 10; cursor: pointer; padding: 0; transform: translateY(-50%);">
              <i [class]="showConfirmPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" style="font-size: 1.2rem;"></i>
            </button>
          </div>
          @if (getPasswordMismatchError()) {
            <small class="text-danger">Passwords do not match</small>
          }
          @if (resetPasswordForm.get('confirmPassword')?.invalid && resetPasswordForm.get('confirmPassword')?.touched && !getPasswordMismatchError()) {
            <small class="text-danger">Please confirm your password</small>
          }
        </div>

        @if (errorMessage) {
          <div class="alert alert-danger mb-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
          </div>
        }

        @if (successMessage) {
          <div class="alert alert-success mb-3" role="alert">
            <i class="bi bi-check-circle"></i> {{ successMessage }}
          </div>
          <p class="text-center text-muted">Redirecting to login page...</p>
        }

        <div class="text-center mb-3">
          <button 
            type="submit" 
            class="btn btn-success px-5" 
            [disabled]="resetPasswordForm.invalid || loading || !!successMessage">
            @if (loading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Resetting...
            } @else {
              <i class="bi bi-key"></i> Reset Password
            }
          </button>
        </div>

        <div class="text-center">
          <p class="text-muted mb-2">
            <a routerLink="/login" class="text-decoration-none">Back to Login</a>
          </p>
        </div>
      </form>
    }
  </div>
</div>
