<div class="container mt-5 position-relative">
  @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-container">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Processing your request...</p>
      </div>
    </div>
  }
  <div class="card shadow p-4" [class.loading-blur]="loading">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Sign-Up As Farmer</h2>
      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="goToHome()">
        <i class="bi bi-house"></i> Home
      </button>
    </div>
    <p class="text-muted text-center mb-4">Create your farmer account to start selling your products</p>
    
    @if (!showOTPForm) {
    <form [formGroup]="signupForm" (ngSubmit)="onSubmit()">

      <!-- Name Fields -->
      <div class="mb-3">
        <label class="form-label">Name</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="firstName" placeholder="First Name" required>
            @if (signupForm.get('firstName')?.invalid && signupForm.get('firstName')?.touched) {
              <small class="text-danger">
                @if (signupForm.get('firstName')?.errors?.['required']) {
                  First name is required
                } @else if (signupForm.get('firstName')?.errors?.['minlength']) {
                  First name must be at least 2 characters
                } @else if (signupForm.get('firstName')?.errors?.['maxlength']) {
                  First name must not exceed 50 characters
                } @else if (signupForm.get('firstName')?.errors?.['invalidFormat']) {
                  First name can only contain letters, spaces, hyphens, and apostrophes
                }
              </small>
            }
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="middleName" placeholder="Middle Name">
            @if (signupForm.get('middleName')?.invalid && signupForm.get('middleName')?.touched) {
              <small class="text-danger">
                @if (signupForm.get('middleName')?.errors?.['minlength']) {
                  Middle name must be at least 2 characters
                } @else if (signupForm.get('middleName')?.errors?.['maxlength']) {
                  Middle name must not exceed 50 characters
                } @else if (signupForm.get('middleName')?.errors?.['invalidFormat']) {
                  Middle name can only contain letters, spaces, hyphens, and apostrophes
                }
              </small>
            }
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="lastName" placeholder="Last Name" required>
            @if (signupForm.get('lastName')?.invalid && signupForm.get('lastName')?.touched) {
              <small class="text-danger">
                @if (signupForm.get('lastName')?.errors?.['required']) {
                  Last name is required
                } @else if (signupForm.get('lastName')?.errors?.['minlength']) {
                  Last name must be at least 2 characters
                } @else if (signupForm.get('lastName')?.errors?.['maxlength']) {
                  Last name must not exceed 50 characters
                } @else if (signupForm.get('lastName')?.errors?.['invalidFormat']) {
                  Last name can only contain letters, spaces, hyphens, and apostrophes
                }
              </small>
            }
          </div>
        </div>
      </div>

      <!-- Contact -->
      <div class="mb-3">
        <label for="phone" class="form-label">Phone Number</label>
        <input type="tel" class="form-control" id="phone" formControlName="phone" placeholder="98XXXXXXXX" required>
        @if (signupForm.get('phone')?.invalid && signupForm.get('phone')?.touched) {
          <small class="text-danger">
            @if (signupForm.get('phone')?.errors?.['required']) {
              Phone number is required
            } @else if (signupForm.get('phone')?.errors?.['invalidFormat']) {
              Phone number must be exactly 10 digits
            } @else if (signupForm.get('phone')?.errors?.['invalidPrefix']) {
              Phone number must start with 9 (Nepal mobile number)
            }
          </small>
        }
        <small class="text-muted">Enter 10-digit mobile number starting with 9</small>
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" formControlName="email" placeholder="your@email.com" required>
        @if (signupForm.get('email')?.invalid && signupForm.get('email')?.touched) {
          <small class="text-danger">
            @if (signupForm.get('email')?.errors?.['required']) {
              Email is required
            } @else if (signupForm.get('email')?.errors?.['invalidFormat']) {
              Please enter a valid email address
            } @else if (signupForm.get('email')?.errors?.['maxlength']) {
              Email must not exceed 100 characters
            }
          </small>
        }
      </div>

      <!-- Address -->
      <div class="mb-3">
        <label for="province" class="form-label">Province</label>
        <select class="form-select" id="province" formControlName="province" required>
          <option value="">Select Province</option>
          @for (province of provinces; track province) {
            <option [value]="province">{{ province }}</option>
          }
        </select>
        @if (signupForm.get('province')?.invalid && signupForm.get('province')?.touched) {
          <small class="text-danger">Province is required</small>
        }
      </div>

      <div class="mb-3">
        <label for="city" class="form-label">City</label>
        <input type="text" class="form-control" id="city" formControlName="city" placeholder="City" required>
        @if (signupForm.get('city')?.invalid && signupForm.get('city')?.touched) {
          <small class="text-danger">
            @if (signupForm.get('city')?.errors?.['required']) {
              City is required
            } @else if (signupForm.get('city')?.errors?.['minlength']) {
              City must be at least 2 characters
            } @else if (signupForm.get('city')?.errors?.['maxlength']) {
              City must not exceed 50 characters
            }
          </small>
        }
      </div>

      <div class="mb-3">
        <label for="street" class="form-label">Street Address</label>
        <input type="text" class="form-control" id="street" formControlName="street" placeholder="Street address" required>
        @if (signupForm.get('street')?.invalid && signupForm.get('street')?.touched) {
          <small class="text-danger">
            @if (signupForm.get('street')?.errors?.['required']) {
              Street address is required
            } @else if (signupForm.get('street')?.errors?.['minlength']) {
              Street address must be at least 5 characters
            } @else if (signupForm.get('street')?.errors?.['maxlength']) {
              Street address must not exceed 200 characters
            }
          </small>
        }
      </div>

      <!-- Password -->
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <div class="position-relative">
          <input 
            [type]="showPassword ? 'text' : 'password'" 
            class="form-control" 
            id="password" 
            formControlName="password" 
            placeholder="Enter strong password" 
            style="padding-right: 3rem;"
            required>
          <button 
            type="button" 
            class="btn btn-link position-absolute top-50 translate-middle-y" 
            (click)="togglePasswordVisibility()"
            style="right: 0.75rem; border: none; background: none; z-index: 10; cursor: pointer; padding: 0; transform: translateY(-50%);">
            <i [class]="showPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" style="font-size: 1.2rem;"></i>
          </button>
        </div>
        @if (signupForm.get('password')?.invalid && signupForm.get('password')?.touched) {
          <div class="text-danger small">
            <div><strong>Password requirements:</strong></div>
            <ul class="mb-0 ps-3">
              @if (signupForm.get('password')?.errors?.['minlength']) {
                <li>Have at least 8 characters</li>
              }
              @if (signupForm.get('password')?.errors?.['uppercase']) {
                <li>Contain at least one uppercase letter</li>
              }
              @if (signupForm.get('password')?.errors?.['lowercase']) {
                <li>Contain at least one lowercase letter</li>
              }
              @if (signupForm.get('password')?.errors?.['number']) {
                <li>Contain at least one number</li>
              }
              @if (signupForm.get('password')?.errors?.['special']) {
                <li>Contain at least one special character (&#64;, $, !, %, *, ?, & etc.)</li>
              }
            </ul>
          </div>
        } @else {
          <small class="text-muted">Password must be at least 8 characters with uppercase, lowercase, number, and special character</small>
        }
      </div>

      <div class="mb-4">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <div class="position-relative">
          <input 
            [type]="showConfirmPassword ? 'text' : 'password'" 
            class="form-control" 
            id="confirmPassword" 
            formControlName="confirmPassword" 
            placeholder="Confirm your password" 
            style="padding-right: 3rem;"
            required>
          <button 
            type="button" 
            class="btn btn-link position-absolute top-50 translate-middle-y" 
            (click)="toggleConfirmPasswordVisibility()"
            style="right: 0.75rem; border: none; background: none; z-index: 10; cursor: pointer; padding: 0; transform: translateY(-50%);">
            <i [class]="showConfirmPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" style="font-size: 1.2rem;"></i>
          </button>
        </div>
        @if (signupForm.hasError('mismatch') && signupForm.get('confirmPassword')?.touched) {
          <small class="text-danger">Passwords do not match</small>
        }
      </div>

      @if (successMessage) {
        <div class="alert alert-success mb-3" role="alert">
          <i class="bi bi-check-circle"></i> {{ successMessage }}
          <br>
          <small>Redirecting you to your dashboard...</small>
        </div>
      }

      @if (errorMessage) {
        <div class="alert alert-danger mb-3" role="alert">
          <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
        </div>
      }

      <div class="text-center mb-3">
        <button type="submit" class="btn btn-success px-5" [disabled]="signupForm.invalid || loading">
          @if (loading) {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Signing Up...
          } @else {
            <i class="bi bi-person-plus"></i> Sign Up
          }
        </button>
      </div>

      <div class="text-center">
        <p class="text-muted mb-2">Already have an account?</p>
        <button type="button" class="btn btn-outline-success btn-sm" (click)="goToLogin()">
          <i class="bi bi-box-arrow-in-right"></i> Login
        </button>
      </div>
    </form>
    } @else {
    <!-- OTP Verification Form -->
    <div class="otp-verification">
      <h3 class="text-center mb-3">Verify Your Email</h3>
      <p class="text-center text-muted mb-4">We've sent a 6-digit OTP to <strong>{{ userEmail }}</strong></p>
      
      <form [formGroup]="otpForm" (ngSubmit)="onVerifyOTP()">
        <div class="mb-3">
          <label for="otp" class="form-label">Enter OTP</label>
          <input 
            type="text" 
            class="form-control text-center" 
            id="otp" 
            formControlName="otp" 
            placeholder="XXXXXX" 
            maxlength="6"
            style="font-size: 24px; letter-spacing: 8px; font-family: 'Courier New', monospace;"
            required>
          @if (otpForm.get('otp')?.invalid && otpForm.get('otp')?.touched) {
            <small class="text-danger">Please enter a valid 6-digit OTP</small>
          }
        </div>


        @if (errorMessage) {
          <div class="alert alert-danger mb-3" role="alert">
            {{ errorMessage }}
          </div>
        }

        @if (resendOTPMessage) {
          <div class="alert alert-info mb-3" role="alert">
            {{ resendOTPMessage }}
          </div>
        }

        <div class="text-center mb-3">
          <button 
            type="submit" 
            class="btn btn-success px-5" 
            [disabled]="otpForm.invalid || loading">
            @if (loading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Verifying...
            } @else {
              Verify OTP
            }
          </button>
        </div>

        <div class="text-center">
          <p class="text-muted mb-2">Didn't receive the OTP?</p>
          <button 
            type="button" 
            class="btn btn-outline-success btn-sm resend-otp-btn" 
            (click)="onResendOTP()"
            [disabled]="resendOTPLoading">
            @if (resendOTPLoading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Sending...
            } @else {
              Resend OTP
            }
          </button>
        </div>
      </form>
    </div>
    }
  </div>
</div>
