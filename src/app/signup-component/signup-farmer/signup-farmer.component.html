<div class="container mt-5 position-relative">
  @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-container">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Processing your request...</p>
      </div>
    </div>
  }
  <div class="card shadow p-4" [class.loading-blur]="loading">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Sign-Up As Farmer</h2>
      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="goToHome()">
        <i class="bi bi-house"></i> Home
      </button>
    </div>
    <p class="text-muted text-center mb-4">Create your farmer account to start selling your products</p>
    
    @if (!showOTPForm) {
    <form [formGroup]="signupForm" (ngSubmit)="onSubmit()">

      <!-- Name Fields -->
      <div class="mb-3">
        <label class="form-label">Name</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="firstName" placeholder="First Name" required>
            @if (signupForm.get('firstName')?.invalid && signupForm.get('firstName')?.touched) {
              <small class="text-danger">First name is required</small>
            }
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="middleName" placeholder="Middle Name">
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" formControlName="lastName" placeholder="Last Name" required>
            @if (signupForm.get('lastName')?.invalid && signupForm.get('lastName')?.touched) {
              <small class="text-danger">Last name is required</small>
            }
          </div>
        </div>
      </div>

      <!-- Contact -->
      <div class="mb-3">
        <label for="phone" class="form-label">Phone Number</label>
        <input type="tel" class="form-control" id="phone" formControlName="phone" placeholder="10-digit phone number" required>
        @if (signupForm.get('phone')?.invalid && signupForm.get('phone')?.touched) {
          <small class="text-danger">Valid 10-digit phone number is required</small>
        }
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" formControlName="email" placeholder="your@email.com" required>
        @if (signupForm.get('email')?.invalid && signupForm.get('email')?.touched) {
          <small class="text-danger">Valid email is required</small>
        }
      </div>

      <!-- Address -->
      <div class="mb-3">
        <label for="province" class="form-label">Province</label>
        <select class="form-select" id="province" formControlName="province" required>
          <option value="">Select Province</option>
          @for (province of provinces; track province) {
            <option [value]="province">{{ province }}</option>
          }
        </select>
        @if (signupForm.get('province')?.invalid && signupForm.get('province')?.touched) {
          <small class="text-danger">Province is required</small>
        }
      </div>

      <div class="mb-3">
        <label for="city" class="form-label">City</label>
        <input type="text" class="form-control" id="city" formControlName="city" placeholder="City" required>
        @if (signupForm.get('city')?.invalid && signupForm.get('city')?.touched) {
          <small class="text-danger">City is required</small>
        }
      </div>

      <div class="mb-3">
        <label for="street" class="form-label">Street Address</label>
        <input type="text" class="form-control" id="street" formControlName="street" placeholder="Street address" required>
        @if (signupForm.get('street')?.invalid && signupForm.get('street')?.touched) {
          <small class="text-danger">Street address is required</small>
        }
      </div>

      <!-- Password -->
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" formControlName="password" placeholder="Minimum 6 characters" required>
        @if (signupForm.get('password')?.invalid && signupForm.get('password')?.touched) {
          <small class="text-danger">Password must be at least 6 characters</small>
        }
      </div>

      <div class="mb-4">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <input type="password" class="form-control" id="confirmPassword" formControlName="confirmPassword" placeholder="Confirm your password" required>
        @if (signupForm.hasError('mismatch') && signupForm.get('confirmPassword')?.touched) {
          <small class="text-danger">Passwords do not match</small>
        }
      </div>

      @if (successMessage) {
        <div class="alert alert-success mb-3" role="alert">
          <i class="bi bi-check-circle"></i> {{ successMessage }}
          <br>
          <small>Redirecting you to your dashboard...</small>
        </div>
      }

      @if (errorMessage) {
        <div class="alert alert-danger mb-3" role="alert">
          <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
        </div>
      }

      <div class="text-center mb-3">
        <button type="submit" class="btn btn-success px-5" [disabled]="signupForm.invalid || loading">
          @if (loading) {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Signing Up...
          } @else {
            <i class="bi bi-person-plus"></i> Sign Up
          }
        </button>
      </div>

      <div class="text-center">
        <p class="text-muted mb-2">Already have an account?</p>
        <button type="button" class="btn btn-outline-success btn-sm" (click)="goToLogin()">
          <i class="bi bi-box-arrow-in-right"></i> Login
        </button>
      </div>
    </form>
    } @else {
    <!-- OTP Verification Form -->
    <div class="otp-verification">
      <h3 class="text-center mb-3">Verify Your Email</h3>
      <p class="text-center text-muted mb-4">We've sent a 6-digit OTP to <strong>{{ userEmail }}</strong></p>
      
      <form [formGroup]="otpForm" (ngSubmit)="onVerifyOTP()">
        <div class="mb-3">
          <label for="otp" class="form-label">Enter OTP</label>
          <input 
            type="text" 
            class="form-control text-center" 
            id="otp" 
            formControlName="otp" 
            placeholder="000000" 
            maxlength="6"
            style="font-size: 24px; letter-spacing: 8px; font-family: 'Courier New', monospace;"
            required>
          @if (otpForm.get('otp')?.invalid && otpForm.get('otp')?.touched) {
            <small class="text-danger">Please enter a valid 6-digit OTP</small>
          }
        </div>

        @if (successMessage) {
          <div class="alert alert-success mb-3" role="alert">
            {{ successMessage }}
          </div>
        }

        @if (errorMessage) {
          <div class="alert alert-danger mb-3" role="alert">
            {{ errorMessage }}
          </div>
        }

        @if (resendOTPMessage) {
          <div class="alert alert-info mb-3" role="alert">
            {{ resendOTPMessage }}
          </div>
        }

        <div class="text-center mb-3">
          <button 
            type="submit" 
            class="btn btn-success px-5" 
            [disabled]="otpForm.invalid || loading">
            @if (loading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Verifying...
            } @else {
              Verify OTP
            }
          </button>
        </div>

        <div class="text-center">
          <p class="text-muted mb-2">Didn't receive the OTP?</p>
          <button 
            type="button" 
            class="btn btn-outline-success btn-sm resend-otp-btn" 
            (click)="onResendOTP()"
            [disabled]="resendOTPLoading">
            @if (resendOTPLoading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Sending...
            } @else {
              Resend OTP
            }
          </button>
        </div>
      </form>
    </div>
    }
  </div>
</div>
